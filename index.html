<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ESG Pulse | Audit Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f6; color: #333; display: flex; justify-content: center; padding: 20px; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; flex-wrap: wrap; }
        
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); flex: 1; min-width: 300px; position: relative; }
        
        h2 { font-size: 18px; color: #1e293b; border-bottom: 2px solid #6366f1; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Inputs & Buttons */
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
        
        /* Bouton Principal */
        .btn-primary { width: 100%; padding: 14px; background: #6366f1; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: #4f46e5; transform: translateY(-2px); }

        /* Bouton Export (Nouveau) */
        .btn-export { position: absolute; top: 20px; right: 20px; background: #10b981; color: white; padding: 8px 15px; border-radius: 6px; font-size: 12px; font-weight: bold; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px; text-decoration: none;}
        .btn-export:hover { background: #059669; }

        /* Zone Pr√©dictive */
        .prediction-box {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;
        }
        .pred-value { font-size: 32px; font-weight: bold; margin: 10px 0; color: #38bdf8; }
        .pred-alert { font-size: 14px; font-weight: 600; padding: 5px 10px; border-radius: 20px; display: inline-block;}
        .alert-ok { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .alert-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px;}
        th { background: #f1f5f9; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .chart-container { height: 250px; width: 100%; position: relative; display: flex; justify-content: center; }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="card" style="flex: 0 0 300px;">
            <h2>‚ö° Injection Donn√©es</h2>
            <label>Entit√©</label><input type="text" id="entite" placeholder="Ex: Usine Lyon">
            <label>Source</label>
            <select id="type_activite">
                <option value="√âlectricit√©">√âlectricit√©</option>
                <option value="Gaz">Gaz Naturel</option>
                <option value="Flotte">Flotte Auto</option>
                <option value="Fret">Fret A√©rien</option>
            </select>
            <label>Quantit√©</label><input type="number" id="quantite">
            <label>Facteur √âmission</label><input type="number" id="fe" value="0.05" step="0.001">
            <label>Admin Key</label><input type="password" id="passkey">
            <button class="btn-primary" onclick="addEmission()">Injecter</button>
        </div>

        <div class="card">
            <h2>üîÆ Oracle & Audit</h2>
            
            <button onclick="exportCSV()" class="btn-export">
                <i class="fa-solid fa-file-csv"></i> Export CSV
            </button>
            
            <div class="prediction-box">
                <div style="font-size:12px; text-transform:uppercase; color:#94a3b8;">Projection 2025</div>
                <div id="pred-val" class="pred-value">-- tCO2e</div>
                <div id="pred-msg" class="pred-alert">Calcul en cours...</div>
            </div>

            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>

            <div style="overflow-y: auto; max-height: 200px;">
                <table id="emissions-table">
                    <thead><tr><th>Date</th><th>Source</th><th>tCO2e</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const _url = "https://ykrxslzmvhilmhkdicqj.supabase.co"; 
        const _key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcnhzbHptdmhpbG1oa2RpY3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjAxNTAsImV4cCI6MjA4MjQzNjE1MH0.l0piAICXO6Sjqufjxlbo8nIYqVHEL5lxbzyHJRygEXI"; // <--- TA CLE ICI
        const supabaseClient = supabase.createClient(_url, _key);
        const QUOTA_ANNUEL = 250;
        let globalData = []; // On stocke les donn√©es pour l'export
        let myChart = null;

        async function loadData() {
            const { data } = await supabaseClient.from('emissions').select('*').order('created_at', { ascending: false });

            if (data) {
                globalData = data; // Sauvegarde pour l'export CSV
                let total = 0;
                let categories = {};
                const body = document.getElementById('table-body');
                body.innerHTML = "";

                data.forEach(row => {
                    total += row.tco2_total;
                    categories[row.type_activite] = (categories[row.type_activite] || 0) + row.tco2_total;
                    body.innerHTML += `<tr><td>${new Date(row.date_reporting).toLocaleDateString()}</td><td>${row.type_activite}</td><td><strong>${row.tco2_total.toFixed(2)}</strong></td></tr>`;
                });

                updateChart(categories);
                calculateProjection(total);
            }
        }

        // --- MOTEUR GRAPHIQUE (DONUT RESTAUR√â) ---
        function updateChart(dataMap) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'doughnut', // <--- RETOUR DU DONUT
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // --- MOTEUR PR√âDICTIF ---
        function calculateProjection(currentTotal) {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 1)) / 86400000) || 1;
            const projection = (currentTotal / dayOfYear) * 365;
            
            const divVal = document.getElementById('pred-val');
            const divMsg = document.getElementById('pred-msg');
            divVal.innerText = `${projection.toFixed(0)} tCO2e`;

            if (projection > QUOTA_ANNUEL) {
                divMsg.className = "pred-alert alert-danger";
                divMsg.innerText = `‚ö†Ô∏è D√âPASSEMENT PR√âVU`;
            } else {
                divMsg.className = "pred-alert alert-ok";
                divMsg.innerText = "‚úÖ OBJECTIF S√âCURIS√â";
            }
        }

        // --- MOTEUR EXPORT CSV (NOUVEAU) ---
        function exportCSV() {
            if (!globalData.length) return alert("Pas de donn√©es √† exporter !");
            
            // 1. Cr√©ation de l'en-t√™te CSV
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Entite,Source,Quantite,FacteurEmission,Total_tCO2e\n"; // Header

            // 2. Remplissage ligne par ligne
            globalData.forEach(row => {
                const date = row.date_reporting.split('T')[0];
                csvContent += `${date},${row.entite},${row.type_activite},${row.quantite_physique},${row.facteur_emission},${row.tco2_total}\n`;
            });

            // 3. T√©l√©chargement forc√© via le navigateur
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "esg_audit_export.csv");
            document.body.appendChild(link); // Requis pour Firefox
            link.click(); // Clic automatique
            document.body.removeChild(link); // Nettoyage
        }

        // --- INSERTION ---
        async function addEmission() {
            const pass = document.getElementById('passkey').value;
            if (pass !== "admin123") return alert("‚õî");
            
            const entite = document.getElementById('entite').value;
            const type = document.getElementById('type_activite').value;
            const quantite = parseFloat(document.getElementById('quantite').value);
            const fe = parseFloat(document.getElementById('fe').value);

            if (!entite) return;

            await supabaseClient.from('emissions').insert({
                date_reporting: new Date().toISOString(),
                entite: entite,
                categorie_scope: 'Scope 1',
                type_activite: type,
                quantite_physique: quantite,
                unite_mesure: 'u',
                facteur_emission: fe
            });
            loadData();
        }

        loadData();
    </script>
</body>
</html>
