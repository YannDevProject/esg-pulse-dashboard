<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ESG Pulse | Predictive AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f6; color: #333; display: flex; justify-content: center; padding: 20px; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; flex-wrap: wrap; }
        
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); flex: 1; min-width: 300px; }
        
        h2 { font-size: 18px; color: #1e293b; border-bottom: 2px solid #6366f1; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Inputs & Buttons */
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
        button { width: 100%; padding: 14px; background: #6366f1; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #4f46e5; transform: scale(1.02); }

        /* Zone Pr√©dictive */
        .prediction-box {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;
        }
        .pred-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; }
        .pred-value { font-size: 32px; font-weight: bold; margin: 10px 0; color: #38bdf8; }
        .pred-alert { font-size: 14px; font-weight: 600; padding: 5px 10px; border-radius: 20px; display: inline-block;}
        .alert-ok { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .alert-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px;}
        th { background: #f1f5f9; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .chart-container { height: 200px; width: 100%; position: relative; }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="card" style="flex: 0 0 300px;">
            <h2>‚ö° Injection Donn√©es</h2>
            <label>Entit√©</label><input type="text" id="entite" placeholder="Ex: Usine Lyon">
            <label>Source</label>
            <select id="type_activite">
                <option value="√âlectricit√©">√âlectricit√©</option>
                <option value="Gaz">Gaz Naturel</option>
                <option value="Flotte">Flotte Auto</option>
                <option value="Fret">Fret A√©rien</option>
            </select>
            <label>Quantit√©</label><input type="number" id="quantite">
            <label>Facteur √âmission</label><input type="number" id="fe" value="0.05" step="0.001">
            <label>Admin Key</label><input type="password" id="passkey">
            <button onclick="addEmission()">Injecter</button>
        </div>

        <div class="card">
            <h2>üîÆ Oracle Pr√©dictif 2025</h2>
            
            <div class="prediction-box">
                <div class="pred-title">Projection Fin d'Ann√©e (Estimation Lin√©aire)</div>
                <div id="pred-val" class="pred-value">-- tCO2e</div>
                <div id="pred-msg" class="pred-alert">En attente de donn√©es...</div>
                <div style="margin-top:10px; font-size:12px; color:#cbd5e1">
                    Actuel : <span id="current-total">0</span> tCO2e | Objectif : 250 tCO2e
                </div>
            </div>

            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>

            <div style="overflow-y: auto; max-height: 200px;">
                <table id="emissions-table">
                    <thead><tr><th>Date</th><th>Source</th><th>tCO2e</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const _url = "https://ykrxslzmvhilmhkdicqj.supabase.co"; 
        const _key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcnhzbHptdmhpbG1oa2RpY3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjAxNTAsImV4cCI6MjA4MjQzNjE1MH0.l0piAICXO6Sjqufjxlbo8nIYqVHEL5lxbzyHJRygEXI"; // <--- REMETTRE TA CLE ICI
        const supabaseClient = supabase.createClient(_url, _key);
        const QUOTA_ANNUEL = 250; // Ton objectif fictif

        let myChart = null;

        async function loadData() {
            const { data } = await supabaseClient.from('emissions').select('*').order('created_at', { ascending: false });

            if (data) {
                let total = 0;
                let categories = {};
                const body = document.getElementById('table-body');
                body.innerHTML = "";

                // Calculs de base
                data.forEach(row => {
                    total += row.tco2_total;
                    categories[row.type_activite] = (categories[row.type_activite] || 0) + row.tco2_total;
                    body.innerHTML += `<tr><td>${new Date(row.date_reporting).toLocaleDateString()}</td><td>${row.type_activite}</td><td><strong>${row.tco2_total.toFixed(2)}</strong></td></tr>`;
                });

                document.getElementById('current-total').innerText = total.toFixed(2);
                updateChart(categories);
                
                // --- MOTEUR PR√âDICTIF (L'Intelligence) ---
                calculateProjection(total);
            }
        }

        function calculateProjection(currentTotal) {
            // Algorithme simple : R√®gle de 3 sur l'ann√©e
            const today = new Date();
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            const dayOfYear = Math.floor((today - startOfYear) / (1000 * 60 * 60 * 24)) || 1; // Eviter division par 0
            
            // Vitesse moyenne par jour (Burn Rate)
            const dailyRate = currentTotal / dayOfYear;
            
            // Projection sur 365 jours
            const projection = dailyRate * 365;

            // Affichage
            const divVal = document.getElementById('pred-val');
            const divMsg = document.getElementById('pred-msg');

            divVal.innerText = `${projection.toFixed(0)} tCO2e`;

            if (projection > QUOTA_ANNUEL) {
                divMsg.className = "pred-alert alert-danger";
                divMsg.innerText = `‚ö†Ô∏è D√âPASSEMENT PR√âVU (+${(projection - QUOTA_ANNUEL).toFixed(0)}t)`;
            } else {
                divMsg.className = "pred-alert alert-ok";
                divMsg.innerText = "‚úÖ DANS LES CLOUS";
            }
        }

        function updateChart(dataMap) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar', // On change en Barres pour varier
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        label: '√âmissions par Source',
                        data: Object.values(dataMap),
                        backgroundColor: '#6366f1',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function addEmission() {
            const pass = document.getElementById('passkey').value;
            if (pass !== "admin123") return alert("‚õî");
            
            const entite = document.getElementById('entite').value;
            const type = document.getElementById('type_activite').value;
            const quantite = parseFloat(document.getElementById('quantite').value);
            const fe = parseFloat(document.getElementById('fe').value);

            if (!entite) return;

            await supabaseClient.from('emissions').insert({
                date_reporting: new Date().toISOString(),
                entite: entite,
                categorie_scope: 'Scope 1',
                type_activite: type,
                quantite_physique: quantite,
                unite_mesure: 'u',
                facteur_emission: fe
            });
            loadData();
        }

        loadData();
    </script>
</body>
</html>
